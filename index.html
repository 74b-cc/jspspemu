<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://developers.google.com/chrome/mobile/docs/installtohomescreen -->
    <meta charset="utf-8" />
    <title>jspspemu</title>
    <meta name="viewport" content="width=480, initial-scale=0.75, maximum-scale=0.75, minimum-scale=0.75, user-scalable=no">

    <link rel="shortcut icon" href="icon.png" id="dynamic-favicon" />

    <link rel="apple-touch-icon" href="./icon.png" />
    <link rel="apple-touch-icon-precomposed" href="icon.png" />

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="stylesheet" href="pspemu.css" />

    <script src="lib/aes.js"></script>
    <script src="lib/sha1.js"></script>
    <script src="lib/lib-typedarrays-min.js"></script>
    <script src="lib/dropbox-datastores-1.0-latest.js" type="text/javascript"></script>

    <script src="lib/jquery-2.1.0.js"></script>
    <script src="lib/gl-matrix.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/zlib_and_gzip.min.js"></script>
    <script src="lib/zlib/rawinflate.min.js"></script>
    <script src="lib/sprintf.js"></script>
    <script src="lib/FileSaver.js"></script>
    <script src="polyfills/promise.js"></script>
    <!--
    <script src="polyfills/es6-collections.min.js"></script>
    <script src="polyfills/setImmediate.js"></script>
    -->
    <script src="lib/mocha.js"></script>
    <script src="lib/chai.js"></script>
    <script src="lib/difflib.js"></script>
    <script>
        mocha.setup('bdd');
        var expect = chai.expect;
        var assert = chai.assert;
    </script>

    <script src="workertask.js"></script>
    <script src="MediaEngine.js"></script>

    <script src="jspspemu.js"></script>
</head>
<body>
    <div id="body">
        <div id="header_info" style="background:transparent;">
            <center>
                <select id="files" style="width:110px;"></select>
                <!--
                <select id="scale"><option value="1.0">1.0x</option><option value="1.5">1.5x</option><option value="2.0">2.0x</option></select>
                -->
                <input type="file" id="load_file" name="load_file" style="width:92px;display:none;" />
                <button onclick="$('#load_file').click();">Select Game...</button>
                <a href="javascript:requestFullScreen();$('#fullScreen').hide();" style="font:16px Arial;color:white;">[Fullscreen]</a>
                <a href="http://github.com/soywiz/jspspemu" style="font:16px Arial;color:white;" target="_blank">[Github]</a>
                <a href="http://blog.jspspemu.com" style="font:16px Arial;color:white;" target="_blank">[Blog]</a>
                <a href="javascript:emulator.memory.dump();" style="font:16px Arial;color:white;">[Dump]</a>
                <a href="javascript:emulator.toggleDropbox();" style="font:16px Arial;color:white;">[Dropbox]</a>
                <span id="dropbox" style="color:white;"></span>
            </center>
        </div>
        <div id="canvas_container">
            <div id="touch_buttons_font" style="position:absolute;">
                <div id="touch_buttons">
                    <span id="directional_pad">
                        <span class="psp_button" id="button_left">2</span>
                        <span class="psp_button" id="button_up">3</span>
                        <span class="psp_button" id="button_right">1</span>
                        <span class="psp_button" id="button_down">4</span>
                        <span class="psp_button" id="button_up_right">5</span>
                        <span class="psp_button" id="button_down_right">6</span>
                        <span class="psp_button" id="button_up_left">7</span>
                        <span class="psp_button" id="button_down_left">8</span>
                    </span>

                    <span id="button_pad">
                        <span class="psp_button" id="button_cross">X</span>
                        <span class="psp_button" id="button_circle">C</span>
                        <span class="psp_button" id="button_triangle">T</span>
                        <span class="psp_button" id="button_square">S</span>
                    </span>

                    <span id="lr_pad">
                        <span class="psp_button" id="button_l">l</span>
                        <span class="psp_button" id="button_r">r</span>
                    </span>

                    <span id="select_start_pad">
                        <span class="psp_button" id="button_start">A</span>
                        <span class="psp_button" id="button_select">B</span>
                    </span>
                </div>
            </div>
            <canvas id="canvas" width="480" height="272" style="background: black; width: 960px; height: 544px; border: 0; display: block;"></canvas>
            <!--
                <canvas id="webgl_canvas" width="480" height="272" style="background: black; width: 480px; height: 272px; border: 0; display: none; "></canvas>
                -->
            <canvas id="webgl_canvas" width="960" height="544" style="background: black; width: 960px; height: 544px; border: 0; display: none; "></canvas>
        </div>
        <div id="thread_list" style="color:white;"></div>
        <div id="output"></div>
    </div>
    <script>
        var demos = [
            "-CPU",
            "compilerPerf.elf",
            "counter.elf",
            "fputest.elf",
            "mytest.elf",

            "-OS",
            "rtctest.elf",
            "rtctest.pbp",
            "threadstatus.elf",
            "taskScheduler.prx",
            "power.pbp",
            "controller.elf",

            "-IO",
            "mstick.pbp",
            "cwd.elf",
            "ioasync.pbp",

            "-AUDIO",
            "polyphonic.elf",

            "-DISPLAY",
            "displayWait.prx",
            "minifire.elf",
            "HelloWorldPSP.elf",

            "-GPU",
            "2dstudio.prx",
            "3dstudio.pbp",
            "ortho.elf",
            "cube.elf",
            "cube.iso",
            "lights.pbp",
            "skinning.pbp",
            "sprite.pbp",
            "lines.pbp",
            "clut.pbp",
            "reflection.pbp",
            "text.elf",
            "intraFontTest.elf",
            "blend.pbp",
            "nehetutorial02.pbp",
            "nehetutorial03.pbp",
            "nehetutorial04.pbp",
            "nehetutorial05.pbp",
            "nehetutorial06.pbp",
            "nehetutorial07.pbp",
            "nehetutorial08.pbp",
            "nehetutorial09.pbp",
            "nehetutorial10.pbp",

            "-GAMES",
            "cavestory.zip",
            "TrigWars.zip",
            "goldminer.zip",
            "Doom.zip",
            "cdogs.zip",
            "jazz.zip",
            "SkyRoads.zip",
            "PSPTris.zip",
            "Alex4C.zip",
            //"reminiscence/EBOOT.PBP",
            //"UraKaitenPatissierPSP/EBOOT.PBP",
            //"Doom/EBOOT.PBP",
        ];

        function updateScaleWith(scale) {
            var width = 480 * scale, height = 272 * scale;
            //console.info(sprintf('updateScale: %f, %dx%d', scale, width, height));
            $('#body').css('width', width + 'px');
            $('#canvas,#webgl_canvas').css('width', width + 'px').css('height', height + 'px');
            $('#touch_buttons').css('width', width + 'px').css('height', height + 'px').css('font-size', scale + 'em');
            //$('#touch_buttons').css('transform', 'scale(' + scale + ')').css('-webkit-transform', 'scale(' + scale + ')');
        }

        function updateScale() {
            updateScaleWith(parseFloat($('#scale').val()));
        }

        $('#scale').change(function () { updateScale(); });
        updateScale();

        $('#files').html('');
        var selectedItem = document.location.hash.substr(1);
        $('#files').append('<option value="">-- DEMOS --</option>');
        demos.forEach(function (fileName) {
            if (fileName.substr(0, 1) == '-') {
                $('#files').append($('<option disabled style="background:#eee;">' + fileName.substr(1) + '</option>'));
            } else {
                var path = 'samples/' + fileName;
                var item = $('<option value="' + path + '">' + fileName + '</option>');
                if (selectedItem == path) item.attr('selected', 'selected')
                $('#files').append(item);
            }
        });
        $('#files').change(function () {
            console.clear();
            document.location.hash = $('#files').val();
            document.location.reload();
            //emulator.downloadAndExecuteAsync(document.location.hash.substr(1));
            //downloadAnd
            //document.location = 'index.html?' + $('#files').val();
        });
        $('#load_file').change(function (e) {
            if (e.target.files && e.target.files.length > 0) {
                console.clear();
                emulator.executeFileAsync(e.target.files[0]);
            }
        });
        $(window).on('hashchange', function() {
            console.clear();
            emulator.downloadAndExecuteAsync(document.location.hash.substr(1));
        });
        //$(document.body).click(function (e) { e.preventDefault() });
        //$(document.body).mousedown(function (e) { e.preventDefault() });
        //$(document.body).mouseup(function (e) { e.preventDefault() });

        //$(window).on('select', function (e) { e.preventDefault() });
        //<a href="index.html?' + fileName + '" style="color:white;">
    </script>

    <script>
        $('#touch_buttons_font').css('display', isTouchDevice() ? 'block' : 'none');

        require('src/app');

        function onResize() {
            var position = $('#canvas_container').position();
            var availableHeight = $(window).height() - position.top * 2;
            var availableWidth = $(window).width();

            var scale1 = availableHeight / 272;
            var scale2 = availableWidth / 480;
            var steps = 0.5;
            var scale = Math.min(scale1, scale2);
            //scale = Math.floor(scale * (1 / steps)) / (1 / steps);

            if (scale < steps) scale = steps;

            updateScaleWith(scale);

            var isFullScreen = (document.webkitIsFullScreen || document.mozIsFullScreen) || ((screen.availHeight || screen.height - 30) <= window.innerHeight);

            if (window.innerHeight > window.innerWidth) isFullScreen = false;

            $(document.body).toggleClass('fullscreen', isFullScreen);
        }

        $(window).on('resize', function (e) {
            onResize();
        });

        onResize();

        function requestFullScreen() {
            if (document.body['requestFullScreen']) {
                document.body['requestFullScreen']();
            } else if (document.body['webkitRequestFullScreen']) {
                document.body['webkitRequestFullScreen']();
            } else if (document.body['mozRequestFullScreen']) {
                document.body['mozRequestFullScreen']();
            }
        }

        emulator.checkPlugins();

        window.onerror = function (errorMsg, url, lineNumber, column, errorObj) {
            console.error(errorObj);
            console.error(errorObj['stack']);
            alert('Error: ' + errorMsg + '\n\n' + errorObj['stack']);
        }
    </script>

    <!--
    <script data-main="js/src/app.js" src="lib/require.js"></script>
    -->

    <script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-50864498-1', 'jspspemu.com');
	ga('require', 'displayfeatures');
    ga('send', 'pageview');

    </script>
</body>
</html>
